<html>

<head>
    <style>
        p {
            color: red;
        }

        html {
            font-size: 22px;
        }

        button {
            color: green;
        }

        * {
            margin: 6px;
            padding: 0;
            box-sizing: border-box;
            word-break: break-word;
            color: black;
            font-family: "Courier New", Courier, monospace;
        }
    </style>
</head>

<body>
    <h1>Web components Experiments</h1>

    <custom-modal title="Some modal"></custom-modal>

    <div id="app"></div>

    <div id="unique-id"></div>

    <show-hello name="John"></show-hello>
    <show-hello-with-js name="John with JS"></show-hello-with-js>

    <!-- <template id="tmpl">
        <style>
            p {
                font-weight: bold;
            }
        </style>
        <p id="message"></p>
    </template> -->

    <div id="elem">Click me</div>

    <div>

    </div>

    <!-- <user-card>
        <div>I like to swim.</div>
        <span slot="username">John Smith</span>
        <span slot="birthday">01.01.2001</span>
        <div>...And play volleyball too!</div>
    </user-card> -->


    <div id="some-list-id"></div>

    <!-- <form hx-post="/submit" hx-target="#some-list-id">
        <input name="name" placeholder="Name...">
        <p class="error">Name error</p>
        <input name="password" type="password", placeholder="Password...">
        <p class="error">password error</p>
        <input type="submit" name="Send">
    </form> -->

    <form-with-hideable-errors hx-post="/submit" hx-target="#some-list-id"></form-with-hideable-errors>

    <button id="hide-form-errors">Hide form errors</button>

    <custom-menu>
        <span slot="title">Candy menu</span>
        <li slot="item">Lollipop</li>
        <li slot="item">Fruit Toast</li>
        <li slot="item">Cup Cake</li>
    </custom-menu>

    <custom-menu2 title="Candy menu" items="Lollipop, Fruit Toast, Cup Cake">
    </custom-menu2>

    <script src="https://unpkg.com/htmx.org@1.9.5"
        integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO"
        crossorigin="anonymous"></script>
    <script>
        elem.onclick = () => {
            elem.attachShadow({ mode: 'open' });

            elem.shadowRoot.append(tmpl.content.cloneNode(true)); // (*)

            elem.shadowRoot.getElementById('message').innerHTML = "Hello from the shadows!";
        };

        const CUSTOM_ELEMENT_INITIALIZED_EVENT = "custom-element-initialized";

        console.log("Some Web components");

        class NestedCustomElement extends HTMLElement {
            constructor() {
                super();
                this.innerHTML = `<span>Nested HTML element with a value: ${this.getAttribute("value")}</span>`;
            }

            connectedCallback() {
                console.log("Nested custom element added to page.");
                window.dispatchEvent(new CustomEvent(CUSTOM_ELEMENT_INITIALIZED_EVENT, { detail: "nested-custom-element" }));
            }
        }

        class SomeCustomElement extends HTMLElement {
            static observedAttributes = ["color", "size", "title", "subtitle"];

            constructor() {
                super();
                this.customElementInitializedListener = e => {
                    console.log("Got custom-element-initialized event...", e.detail);
                };
                window.addEventListener(CUSTOM_ELEMENT_INITIALIZED_EVENT, this.customElementInitializedListener);
                this._render();
            }

            _render() {
                const title = this.getAttribute("title");
                const subtitle = this.getAttribute("subtitle");
                this.innerHTML = `<div>
                    <h1>${title}</h1>
                    <p>This is a pretty nice, custom element with subtitle: ${subtitle ? subtitle : title}</p>    
                    <nested-custom-element value="12"></nested-custom-element>
                </div>`;
            }

            connectedCallback() {
                console.log("Custom element added to page.");
            }

            disconnectedCallback() {
                console.log("Custom element removed from page.");
                window.removeEventListener(CUSTOM_ELEMENT_INITIALIZED_EVENT, this.customElementInitializedListener);
            }

            adoptedCallback() {
                console.log("Custom element moved to new page.");
            }

            attributeChangedCallback(name, oldValue, newValue) {
                console.log(`Attribute ${name} has changed.`);
                // this._render();
            }
        }


        if (!customElements.get('some-custom-element')) {
            customElements.define("some-custom-element", SomeCustomElement);
        }

        if (!customElements.get('some-custom-element')) {
            customElements.define("some-custom-element", SomeCustomElement);
        }

        customElements.define("nested-custom-element", NestedCustomElement);

        const customElement = document.querySelector("some-custom-element");

        function createNewCustomElement() {
            const app = document.getElementById("app");
            app.innerHTML = "";
            app.innerHTML = `<some-custom-element size="100" color="red" title="custom-xd" subtitle="sub-custom-xd"></some-custom-element>`;
        }


        createNewCustomElement();


        // setInterval(() => createNewCustomElement(), 5000);

        customElements.define("show-hello", class extends HTMLElement {
            connectedCallback() {
                const shadow = this.attachShadow({ mode: 'open' });
                shadow.innerHTML = `
                <style>
                    p {
                      color: blue;
                      font-size: 24px;
                    }
                </style>

                <p id="unique-id">
                    Hello, ${this.getAttribute('name')}
                 </p>`;
            }
        });

        customElements.define("custom-menu", class extends HTMLElement {
            connectedCallback() {
                const shadow = this.attachShadow({ mode: "open" });

                shadow.innerHTML = `
                <style> /* menu styles */ </style>
                <div class="menu">
                    <slot name="title"></slot>
                    <ul><slot name="item"></slot></ul>
                </div>
                `;

                this.shadowRoot.querySelector('slot[name="title"]').onclick = () => {
                    this.shadowRoot.querySelector(".menu").classList.toggle("cclosed");
                };
            }
        });

        customElements.define("custom-menu2", class extends HTMLElement {
            connectedCallback() {
                const title = this.getAttribute("title");
                const items = this.getAttribute("items").split(",").map(e => `<li>${e.trim()}</li>`);

                const shadow = this.attachShadow({ mode: "open" });

                shadow.innerHTML = `
                <style> /* menu styles */ </style>
                <div class="menu">
                    <div>${title}<div/>
                    <ul>${items}</ul>
                </div>
                `;
            }
        });

        class FormWithHideableErrors extends HTMLElement {

            constructor() {
                super();

                console.log("Set attributes:", this.getAttributeNames());

                const topLevelAttributes = [];
                for (let a of this.getAttributeNames()) {
                    topLevelAttributes.push(`${a}="${this.getAttribute(a)}"`);
                };

                const addCss = css => document.head.appendChild(document.createElement("style")).innerHTML = css;

                addCss(`
                    .form-error {
                        color: red;
                    }
                    .form-error-hidden {
                        display: none;
                    }`);

                this.innerHTML = `
                <form id="custom-form" ${topLevelAttributes.join(" ")}>
                    <input name="name" placeholder="Name...">
                    <p class="form-error">Name error</p>
                    <input name="password" type="password", placeholder="Password...">
                    <p class="form-error">password error</p>
                    <input type="submit" name="Send">
                </form>
                `;

                document.addEventListener("hide-form-errors", e => {
                    const errors = [...this.getElementsByClassName("form-error")];

                    console.log("Hide form errros...", errors);

                    errors.forEach(e => e.classList.add("form-error-hidden"));
                });

                this.querySelector('input[type="submit"]').addEventListener("click", e => {
                    console.log('Form submitted!');
                });

                console.log("Get element by id in the component test", this.querySelector("#app"));
            }

            connectedCallback() {
                // document.querySelector("button").onclick = () => {
                //     console.log("custom click!");
                //     htmx.trigger("#custom-form", "custom-submit");
                // }
            }


        }


        class CustomModal extends HTMLElement {

            constructor() {
                super();
                const shadow = this.attachShadow({ mode: 'open' });
                shadow.innerHTML = `
                <style>
                    .modal {
                        display: none;
                        position: fixed;
                        z-index: 1;
                        padding-top: 100px;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        overflow: auto;
                        background-color: rgba(0, 0, 0, 0.5);
                    }

                    .modal-content {
                        background-color: #fefefe;
                        margin: auto;
                        padding: 20px;
                        border: 1px solid #888;
                        width: 80%;
                    }

                    .close {
                        color: #aaaaaa;
                        float: right;
                        font-size: 28px;
                        font-weight: bold;
                    }

                    .close:hover, 
                    .close:focus {
                        color: #000;
                        text-decoration: none;
                        cursor: pointer;
                    }
                </style>

                <div class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <p>Some text in the Modal...</p>
                    </div>
                </div>

                <button>Open Modal</button>
                `
            }

            connectedCallback() {
                const modal = this.shadowRoot.querySelector(".modal");
                const close = modal.querySelector("span");

                const openModalButton = this.shadowRoot.querySelector("button");
                openModalButton.onclick = () => {
                    modal.style.display = "block";
                };
                close.onclick = () => {
                    modal.style.display = "none";
                }
            }
        }

        customElements.define("custom-modal", CustomModal);

        customElements.define("user-card", class extends HTMLElement {
            connectedCallback() {
                this.attachShadow({ mode: 'open' });
                this.shadowRoot.innerHTML = `
                    <div>Name:
                        <slot name="username"></slot>
                    </div>
                    <div>Birthday:
                        <slot name="birthday"></slot>
                    </div>
                    <fieldset>
                        <legend>Other information</legend>
                        <slot></slot>
                    </fieldset>
                `;
            }

        });

        customElements.define("form-with-hideable-errors", FormWithHideableErrors);

        document.getElementById("hide-form-errors").onclick = () => {
            document.dispatchEvent(new Event("hide-form-errors"));
        };

        console.log("Show hello custom element: ", document.querySelector("show-hello").shadowRoot.querySelector("p").innerHTML);
    </script>
</body>
<html>