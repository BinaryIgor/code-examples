# HTMX Production Setup

What you can find:
* app - HTMX + Java 21 with Spring Boot 3 web app; HTML templates are defined in the Java code, all CSS (we use
  Tailwind) and JS files are in the `app/static` dir
* db - Postgres 16 database for the app
* nginx - nginx serving as a reverse proxy, requests rate limiter, ssl certificates handler; it is also essential for
  zero downtime deployments
* nginx-https-setup - throwaway version of nginx used only to set up https
* scripts - various things to automate/speed up operations

What you need:
* Docker for builds and deploys
* Java 21 + compatible Maven version for local development
* DigitalOcean account for running deployment example or just a virtual machine with Docker + ssh access
* Domain to set up HTTPS
* Python 3 + Pip to prepare DigitalOcean infra automatically

Let's go!

## Local development

There is no good production setup without great local development experience.
What do we need?

For CSS, we use Tailwind. I wanted to avoid having package.json only to build CSS, therefore, in the repo we have
tailwind binary downloaded according to the official docs: https://tailwindcss.com/blog/standalone-cli
(we have *tailwindcss-linux-x64* version; in case of problems download a version compatible with your OS).

In general, in the `app/static` dir we have static resources (mostly JS and CSS files). Security rules (see
*SecurityRules.java*) are configured to make them public. What is there, precisely?
* in the lib folder, minified version of the HTMX library https://htmx.org/
* base.js - generic utils for the Web Components defined in components.js
* components.js - a few reusable Web Components
* index.js - global JS useful for things like failed http requests handling, showing/hiding top navigation and so on
* styles.css - input to Tailwind
* live-styles.css - styles generated by Tailwind for local development

That's all! HTML is generated solely in the Java code - check out *UserController.java* and *DayController.java* for
details.

### Static files

First, to have live generated Tailwind styles, run (from `app` dir):
```
bash start_tailwindcss_watch.bash 

Rebuilding...

Done in 473ms.
```

According to `taiwind.config.js`, we watch for any changes in the Java (where the HTML lives) and static files, and generate new CSS file
as `static/live-styles.css`, when changes do occur.

## Database

Our app needs a database; go to the `db` dir and run:
```
bash build_and_run_locally.bash 
```

After building and running Docker image we should see:
```
docker ps

CONTAINER ID   IMAGE                             COMMAND                  CREATED         STATUS         PORTS     NAMES
01759a52e61b   htmx-production-setup-db:latest   "docker-entrypoint.sâ€¦"   9 seconds ago   Up 8 seconds             htmx-production-setup-db
```

## App

To run it locally, we need to have Java 21 + compatible Maven version.

Once we have that, just start *HtmxProductionSetupApp.java* file with:
* working directory - app - needed to serve `static/` folder locally from files, not the classpath
* spring dev profile - the easiest way to do this is to run the app with env variable: `SPRING_PROFILES_ACTIVE=dev`

That's all!

App will connect to the Dockerized Postgres and serve static files from `static` directory, reacting to any changes made
there.
To edit HTML, mostly you need to go to `*Controller.java` files; once you change something there, rebuild and restart
the app in your IDE.
It is pretty fast, and should take no more than 3 - 5 seconds ;)

## Production

As said, to deploy to *production*, we need to have a DigitalOcean account/Virtual machine with ssh access + domain
to generate SSL certificates.

### DigitalOcean infrastructure setup

Go to `scripts` dir and run:
```
bash init_python_env.bash
```

This will create virtual Python environment and install required dependencies (just requests for making http requests).
Then, we can actually create infra; we also need to have a *DigitalOcean* token with write permissions.

Once ready, run (also from scripts dir):
```
# activate venv environment
source venv/bin/activate
export DO_API_TOKEN="<your digital ocean API token>"
export SSH_KEY_FINGERPRINT="<your ssh key fingerprint uploaded to DigitalOcean>"
python3 prepare_infra.py
```

After a minute or two, we should have ready to be used Droplet (Virtual Machine).

### Domain & HTTPS setup

First, a domain is needed. Once you have it, grab the *ip address* of created previously Droplet/Virtual Machine and set up
associated `DNS A` record.

In the root dir, we have `config_prod.env` and there:
```
export DOMAIN="htmx-nonexistentdomain.com"
export DOMAIN_EMAIL="igor@htmx-nonexistentdomain.com"
```

Make sure to change these values to your domain and email accordingly!

Assuming that we have `DNS A` record that points to our newly created Droplet/Virtual Machine, we will
create certs with the help of *Let's Encrypt* and the *Certbot*. To do this, run:
```
bash set_up_https_cert.bash
```

We should see something like:
```
Building and deploying nginx https setup...
Building nginx-https-setup with prod env profile...
Creating package in dist directory for htmx-production-setup-nginx-https-setup:latest image...
Preparing dist dir...
Building image...

...

https setup nginx built, deploying it...

...

App status:
running
App deployed!

...

Setting up certbot and https cert on <your-domain> domain...

Setting up certbot...
certbot 2.10.0 from Certbot Project (certbot-eff**) installed

...

Certbot configured, generating certs...
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator webroot, Installer None
Account registered.
Requesting a certificate for <your-domain>
Performing the following challenges:
http-01 challenge for <your-domain>
Using the webroot path /home/deploy/static for all unmatched domains.
Waiting for verification...
Cleaning up challenges

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/<your-domain>/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/<your-domain>/privkey.pem
This certificate expires on 2024-07-19.
These files will be updated when the certificate renews.
Certbot has set up a scheduled task to automatically renew this certificate in the background.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Certbot set, stopping nginx-https-setup...
htmx-production-setup-nginx-https-setup
nginx-https-setup stopped, https cert with auto renewal prepared!
```

We will validate that it works, along with the auto-renewal of certs, after deploying target Nginx, in the next step.

### Nginx build & deploy

Let's deploy our target Nginx. First, we need to build it; again, from `scripts` dir:
```
# change it to 'local' to test local deployment
export ENV=prod
export APP=nginx
bash build_and_package_app.bash
```
In the `nginx/dist` directory, we have ready to be deployed package - just gzipped Docker image and a bunch of scripts to coordinate the whole process, 
especially updating Nginx config while doing zero downtime deploys & reloading config after new https certs generation.

Let's then deploy it! From `scripts` run:
```
export APP=nginx
bash deploy_app.bash
```

We should see something like:
```
...

Dirs prepared, copying package, this can take a while...
check_proxied_app.bash                                                                                                                           100%  226     6.9KB/s   00:00    
default.conf                                                                                                                                     100% 5294   176.5KB/s   00:00    
htmx-production-setup-nginx.tar.gz                                                                                                               100%   66MB   5.6MB/s   00:11    
load_and_run_app.bash                                                                                                                            100%  275     9.5KB/s   00:00    
reload_nginx_config.sh                                                                                                                           100%   55     1.9KB/s   00:00    
run_app.bash                                                                                                                                     100%  862    29.6KB/s   00:00    
template_nginx_app.conf                                                                                                                          100% 5267   175.4KB/s   00:00    
update_app_url.bash                                                                                                                              100%  756    26.0KB/s   00:00    
update_app_url_pre_start.bash                                                                                                                    100%  388    13.2KB/s   00:00    

Package copied, loading and running app, this can take a while...
Loading htmx-production-setup-nginx:latest image, this can take a while...
Loaded image: htmx-production-setup-nginx:latest
Image loaded, running it...
Removing previous container...
Error response from daemon: No such container: htmx-production-setup-nginx

Starting new htmx-production-setup-nginx version...

Current app url file doesn't exist, skipping!
4b96b1240562b3e05dea6a304a71788a18be02e8f43eca3335250d79e941895c
Checking proxied app connection...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (7) Failed to connect to 0.0.0.0 port 80 after 5 ms: Connection refused
Warning: Problem : connection refused. Will retry in 1 seconds. 10 retries 
Warning: left.
  0   157    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (22) The requested URL returned error: 502
Warning: Problem : HTTP error. Will retry in 1 seconds. 9 retries left.

...

Warning: Problem : HTTP error. Will retry in 1 seconds. 1 retries left.
  0   157    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (22) The requested URL returned error: 502

Proxied connection checked, see if it is what it should be!
```

502 errors are there, because we didn't deploy our app yet, which is hidden behind Nginx. 
We will fix it in the next steps; for now, we can see that https works:
```
curl https://<your-domain>
{ "error": "AppUnavailable", "message": "App is not available" }
```

Let's validate https auto renewal:
```
ssh deploy@<your-domain>

sudo certbot renew --dry-run

Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Processing /etc/letsencrypt/renewal/<your-domain>.conf
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Simulating renewal of an existing certificate for <your-domain>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Congratulations, all simulated renewals succeeded: 
  /etc/letsencrypt/live/<your-domain>/fullchain.pem (success)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Hook 'post-hook' ran with output:
 2024/04/20 18:40:43 [notice] 28#28: signal process started
```

We have Nginx with https ready then.
Before building and deploying our app, we need one more thing - the database.

### Database build & deploy

Let's build it:
```
export ENV=prod
export APP=db
bash build_and_package_app.bash
```

Let's deploy it:
```
export APP=db
bash deploy_app.bash
```

Let's also change default db passwords and set up secret for JWT tokens that our app will issue.
To do that, run:
```
python3 generate_secrets.py 
Go to needed directory and simply run:

echo "jpeEyw38ORKijavUcNamysdMmzovMseWhNRRT8X574M=" > auth-token-key.txt
echo "vlVJToutakyNOYALfM3LYJwTusvVQAYRHrWqmQjqQb44XlvQ" > db-root-password.txt
echo "qJSfLXBTosfmnj0DndQaBXRMJvSPvD8hVxoFeQexOgWGEUrv" > db-password.txt
```

As our output is saying, we need to be in the desired directory and just copy-paste these commands there.
Let's prepare the directory on our remote machine:
```
ssh deploy@<your domain>

# secrets path from config_prod.env
mkdir /home/deploy/.secrets
cd /home/deploy/.secrets

<copy-paste commands from the generate_secrets.py output>

ls -l
total 12
-rw-rw-r-- 1 deploy deploy 45 Apr 20 18:49 auth-token-key.txt
-rw-rw-r-- 1 deploy deploy 49 Apr 20 18:49 db-password.txt
-rw-rw-r-- 1 deploy deploy 49 Apr 20 18:49 db-root-password.txt
```

Now, as we have secrets, let's change db passwords by running `db/change_db_passwords.bash` on our remote machine:
```
# just copy-paste these commands and run them from /home/deploy/.secrets dir

new_root_db_password=$(cat db-root-password.txt)
app_db_user="htmx_app"
app_db_name="htmx_app"
app_db_password=$(cat db-password.txt)

connect_to_db="docker exec -it htmx-production-setup-db psql -U postgres -d postgres -c"
$connect_to_db "ALTER USER postgres WITH password '$new_root_db_password'"
$connect_to_db "ALTER USER ${app_db_user} WITH password '$app_db_password'"
```

As we now have the db and secrets set up, let's finally deploy our app!

### App build & deploy

Let's build it:
```
export ENV=prod
export APP=app

# If you don't have Java 21 & Maven setup run it with:
# export BUILD_IN_DOCKER=true
# ...to build everything inside Docker

bash build_and_package_app.bash
```

Let's deploy it:
```
export APP=app
bash deploy_app.bash
```

We should see something like this:
```
...

Dirs prepared, copying package, this can take a while...
current_url.txt                                                                                                                                  100%   21     0.7KB/s   00:00    
htmx-production-setup-app.tar.gz                                                                                                                 100%  191MB   5.4MB/s   00:35    
load_and_run_app.bash                                                                                                                            100%  271     9.0KB/s   00:00    
run_app.bash       

...

App started, will check if it is running after 5s...
App is running, checking its health-check...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (7) Failed to connect to 0.0.0.0 port 13307 after 7 ms: Connection refused
Warning: Problem : connection refused. Will retry in 3 seconds. 10 retries 
Warning: left.
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (7) Failed to connect to 0.0.0.0 port 13307 after 0 ms: Connection refused
Warning: Problem : connection refused. Will retry in 3 seconds. 9 retries 
Warning: left.
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (7) Failed to connect to 0.0.0.0 port 13307 after 0 ms: Connection refused
Warning: Problem : connection refused. Will retry in 3 seconds. 8 retries 
Warning: left.
10{"status":"UP"}  0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
htmx-production-setup-app app is healthy!

Replacing config with new app url: http://0.0.0.0:13307...
Config updated!
Reloading nginx config...
100    15    0    15    0     0     26      0 --:--:-- --:--:-- --:--:--    26
2024/04/20 19:07:10 [notice] 34#34: signal process started
Nginx is running with new app url (http://0.0.0.0:13307)!
Checking proxied app connection...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent   {"status":"UP"}
Proxied app is healthy!

Nginx updated and running with new app version, cleaning previous after a few seconds!
 Left  Speed
100    15    0    15    0     0    787      0 --:--:-- --:--:-- --:--:--   833

Stopping previous htmx-production-setup-app-backup container...
htmx-production-setup-app-backup
Removing previous container...
htmx-production-setup-app-backup
New htmx-production-setup-app container is up and running!

App loaded, checking its logs and status after 5s...


  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.2.4)

2024-04-20T19:06:57.400Z  INFO 1 --- [htmx-production-setup-app] [           main] c.b.h.HtmxProductionSetupApp             : Starting HtmxProductionSetupApp v1.0-SNAPSHOT using Java 21.0.2 with PID 1 (/htmx-production-setup-app.jar started by root in /)
2024-04-20T19:06:57.408Z  INFO 1 --- [htmx-production-setup-app] [           main] c.b.h.HtmxProductionSetupApp             : The following 1 profile is active: "prod"
2024-04-20T19:07:01.574Z  INFO 1 --- [htmx-production-setup-app] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 13307 (http)
2024-04-20T19:07:01.617Z  INFO 1 --- [htmx-production-setup-app] [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2024-04-20T19:07:01.617Z  INFO 1 --- [htmx-production-setup-app] [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.19]
2024-04-20T19:07:01.881Z  INFO 1 --- [htmx-production-setup-app] [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2024-04-20T19:07:01.883Z  INFO 1 --- [htmx-production-setup-app] [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 4324 ms
2024-04-20T19:07:02.490Z  INFO 1 --- [htmx-production-setup-app] [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2024-04-20T19:07:02.771Z  INFO 1 --- [htmx-production-setup-app] [           main] com.zaxxer.hikari.pool.HikariPool        : HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@577bf0aa
2024-04-20T19:07:02.773Z  INFO 1 --- [htmx-production-setup-app] [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2024-04-20T19:07:03.224Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.database                       : Set default schema name to public
2024-04-20T19:07:04.151Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.changelog                      : Reading from public.databasechangelog
Database is up to date, no changesets to execute
2024-04-20T19:07:04.269Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.changelog                      : Reading from public.databasechangelog
2024-04-20T19:07:04.368Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : UPDATE SUMMARY
2024-04-20T19:07:04.368Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : Run:                          0
2024-04-20T19:07:04.369Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : Previously run:               1
2024-04-20T19:07:04.370Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : Filtered out:                 0
2024-04-20T19:07:04.371Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : -------------------------------
2024-04-20T19:07:04.371Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : Total change sets:            1
2024-04-20T19:07:04.372Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.util                           : Update summary generated
2024-04-20T19:07:04.425Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.lockservice                    : Successfully released change log lock
2024-04-20T19:07:04.427Z  INFO 1 --- [htmx-production-setup-app] [           main] liquibase.command                        : Command execution complete
2024-04-20T19:07:05.281Z  INFO 1 --- [htmx-production-setup-app] [           main] c.b.h.DemoDataInitializer                : Initializing db with demo data...
2024-04-20T19:07:05.784Z  INFO 1 --- [htmx-production-setup-app] [           main] c.b.h.DemoDataInitializer                : Db initialized!
2024-04-20T19:07:07.104Z  INFO 1 --- [htmx-production-setup-app] [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 3 endpoint(s) beneath base path '/actuator'
2024-04-20T19:07:07.334Z  INFO 1 --- [htmx-production-setup-app] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 13307 (http) with context path ''
2024-04-20T19:07:07.408Z  INFO 1 --- [htmx-production-setup-app] [           main] c.b.h.HtmxProductionSetupApp             : Started HtmxProductionSetupApp in 11.339 seconds (process running for 12.697)
2024-04-20T19:07:09.949Z  INFO 1 --- [htmx-production-setup-app] [omcat-handler-0] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2024-04-20T19:07:09.950Z  INFO 1 --- [htmx-production-setup-app] [omcat-handler-0] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2024-04-20T19:07:09.956Z  INFO 1 --- [htmx-production-setup-app] [omcat-handler-0] o.s.web.servlet.DispatcherServlet        : Completed initialization in 6 ms

App status:
running
App deployed!
In case of problems you can rollback to the previous deployment: /home/deploy/deploy/app/previous
```

You might notice random port number - this is intentional and allows for zero downtime deployments.
For now, go to *https://<your-domain\>* and experiment with the app. You can sign in as (*DemoDataInitializer.java*):
```
igor@gmail.com:ComplexPassword12
other@gmail.com:ComplexOtherPassword12
```

## Deploying App changes with Zero Downtime

Let's make a small change and see zero downtime deployment in action. 
Modify some HTML either in *HTMX.java* file or in any of *Controller* files. 

Build application, as we did in the previous step, and deploy it.

During deployment, keep refreshing the app in the browser to see that there is indeed Zero Downtime :)